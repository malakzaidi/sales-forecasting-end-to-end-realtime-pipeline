services:
  minio:
    image: minio/minio:latest
    platform: linux/amd64
    command : server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - '9000:9000'
      - '9001:9001'
    volumes:
      - minio-data:/data
    networks:
     - airflow
     - default
    healthcheck:
      test: ['CMD','curl','-f','http://localhost:9000/minio/health/live']
      interval : 30s
      timeout : 20s
    restart : unless-stopped

  minio-mc:
    image: minio/mc:latest
    platform: linux/amd64
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 10;
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/mlflow-artifacts || true;
      mc anonymous set public myminio/mlflow-artifacts;
      exit 0;
      "

  mlflow:
   image: python:3.11-slim
   command: >
    bash -c "pip install mlflow==2.9.2 psycopg2-binary boto3 &&
           export MLFLOW_S3_ENDPOINT_URL=http://minio:9000 &&
           mlflow server --host 0.0.0.0 --port 5001
           --backend_store-uri postgresql://mlflow:mlflow@mlflow-db:5432/mlflow
           --default-artifact-root s3://mlflow-artifacts/
           --serve-artifacts"
   ports:
     - '5001:5001'
   environment:
     - AWS_ACCESS_KEY_ID=minioadmin
     - AWS_SECRET_ACCESS_KEY=minioadmin
     - AWS_DEFAULT_REGION=us-east-1
     - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
   depends_on:
     - mlflow-db
     - minio
   networks:
     - airflow
     - default
   restart: unless-stopped

  mlflow-db:
   image: postgres:16-alpine
   platform: linux/amd64
   environment:
     - POSTGRES_USER=mlflow
     - POSTGRES_PASSWORD=mlflow
     - POSTGRES_DB=mlflow
   volumes:
     - mlflow-db-volume:/var/lib/postgresql/data
   healthcheck:
     test: ['CMD', 'pg_isready' ,'-U' ,'mlflow']
     interval: 5s
     timeout: 5s
     retries: 5
   networks:
     - airflow
     - default
   restart: unless-stopped

volumes:
 minio-data:
 mlflow-db-volume:

networks:
 airflow:
   external: true
   name: astro-sales-forecasting-end-to-end_98eea6_airflow
 default:
   name: astro-sales-forecasting-end-to-end_98eea6_default
